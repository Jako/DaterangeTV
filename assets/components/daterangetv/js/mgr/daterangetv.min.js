/*!
 * DaterangeTV - Date range custom template variable
 * Version: 1.3.1
 * Build date: 2016-11-17
 */

var daterangeTV=function(a){a=a||{},daterangeTV.superclass.constructor.call(this,a)};Ext.extend(daterangeTV,Ext.Component,{page:{},window:{},grid:{},tree:{},panel:{},combo:{},config:{},jquery:{},form:{}}),Ext.reg("daterangetv",daterangeTV),DaterangeTV=new daterangeTV,DaterangeTV.combo.TV=function(a){a=a||{},Ext.applyIf(a,{name:"tv",hiddenName:"tv",displayField:"name",valueField:"id",fields:["name","id"],pageSize:20,url:DaterangeTV.config.connectorUrl,baseParams:{action:"mgr/tvs/getlist"}}),DaterangeTV.combo.TV.superclass.constructor.call(this,a)},Ext.extend(DaterangeTV.combo.TV,MODx.combo.ComboBox),Ext.reg("daterangetv-combo-tv",DaterangeTV.combo.TV),Ext.apply(Ext.form.VTypes,{daterange:function(a,b){var c=b.parseDate(a);if(!c)return!1;var d=Ext.getCmp(b.startDateField),e=Ext.getCmp(b.endDateField);return d&&(d.maxValue&&c.getTime()==d.maxValue.getTime()||(d.setMaxValue(c),d.validate())),e&&(e.minValue&&c.getTime()==e.minValue.getTime()||(e.setMinValue(c),e.validate())),!0}}),DaterangeTV.combo.DaterangeTV=function(a){a=a||{},Ext.applyIf(a,{xtype:"panel",layout:"column",autoHeight:!0,border:!1,width:400,items:[{xtype:"panel",columnWidth:.5,layout:"form",labelAlign:"top",border:!1,items:[new Ext.form.DateField({fieldLabel:_("daterangetv.from"),name:"from"+a.tvId+"[]",id:"from"+a.tvId,format:a.daterangeFormat,dateWidth:200,allowBlank:a.allowBlank,value:a.daterangeStart,msgTarget:"under",vtype:"daterange",labelStyle:"padding-top:4px",endDateField:"to"+a.tvId,listeners:{change:{fn:this.daterangeOnChange,scope:this}}})]},{xtype:"panel",columnWidth:.5,layout:"form",labelAlign:"top",border:!1,items:[new Ext.form.DateField({fieldLabel:_("daterangetv.to"),name:"to"+a.tvId+"[]",id:"to"+a.tvId,format:a.daterangeFormat,dateWidth:200,allowBlank:!0,value:a.daterangeEnd,msgTarget:"under",vtype:"daterange",labelStyle:"padding-top:4px",startDateField:"from"+a.tvId,listeners:{change:{fn:this.daterangeOnChange,scope:this}}})]}]}),DaterangeTV.combo.DaterangeTV.superclass.constructor.call(this,a)},Ext.extend(DaterangeTV.combo.DaterangeTV,MODx.Panel,{daterangeOnChange:function(){var a={from:Ext.getCmp("from"+this.config.tvId,this.config.daterangeFormat).getValue(),to:Ext.getCmp("to"+this.config.tvId,this.config.daterangeFormat).getValue()};this.setTVValue(a)},setTVValue:function(a){var b=this.getTVValue(),c="",d="",e="";a.from&&(c=new Date(a.from).format("Y-m-d"),e=c+"||",a.to&&(d=new Date(a.to).format("Y-m-d"),e+=d)),this.config.endTV&&Ext.get("tv"+this.config.endTV)?(Ext.get("tv"+this.config.tvId).set({value:c}),Ext.get("tv"+this.config.endTV).set({value:d})):Ext.get("tv"+this.config.tvId).set({value:e}),b!=e&&MODx.fireResourceFormChange()},getTVValue:function(){var a=Ext.get("tv"+this.config.tvId).getValue();if(this.config.endTV&&Ext.get("tv"+this.config.endTV)){var b=Ext.get("tv"+this.config.endTV).getValue();b&&(a=a+"||"+Ext.get("tv"+this.config.endTV).getValue())}return a}}),Ext.reg("daterangetv-combo-daterangetv",DaterangeTV.combo.DaterangeTV),DaterangeTV.Renderer=function(a){if(!a.length)return"";var b=a.split("||"),c=b.length>=1&&new Date(b[0]),d=b.length>=2&&new Date(b[1]),e=MODx.config["daterangetv.manager_format"].split("|"),f=MODx.config["daterangetv.separator"],g=MODx.config["daterangetv.manager_format"].search(/d|j|z/),h=MODx.config["daterangetv.manager_format"].search(/F|m|M|n/),i=MODx.config["daterangetv.manager_format"].search(/o|Y|y/),j=h>g,k=g===-1||h===-1||i===-1||i>h||i>g,l="";return c&&c.getTime()===c.getTime()&&(l=d&&d.getTime()===d.getTime()?c.getFullYear()!=d.getFullYear()?Ext.util.Format.date(c,e[0]+e[1]+e[2])+f+Ext.util.Format.date(d,e[0]+e[1]+e[2]):c.getMonth()!=d.getMonth()?k?Ext.util.Format.date(c,e[0]+e[1]+e[2])+f+Ext.util.Format.date(d,e[1]+e[2]):Ext.util.Format.date(c,e[0]+e[1])+f+Ext.util.Format.date(d,e[0]+e[1]+e[2]):c.getDate()!=d.getDate()?k?j?Ext.util.Format.date(c,e[0]+e[1])+f+Ext.util.Format.date(d,e[1]+e[2]):Ext.util.Format.date(c,e[0]+e[1]+e[2])+f+Ext.util.Format.date(d,e[2]):j?Ext.util.Format.date(c,e[0])+f+Ext.util.Format.date(d,e[0]+e[1]+e[2]):Ext.util.Format.date(c,e[0]+e[1])+f+Ext.util.Format.date(d,e[1]+e[2]):Ext.util.Format.date(c,e[0]+e[1]+e[2]):Ext.util.Format.date(c,e[0]+e[1]+e[2])),l};